name: Tests

on:
  push:
    paths-ignore:
      - 'docs/**'
    branches:
      - main
  pull_request:
    paths-ignore:
      - 'docs/**'
    branches:
      - '**'
  workflow_dispatch:

env:
  POETRY_VERSION: 1.5.1
  MAMBA_NO_BANNER: "1"

jobs:
  tests:
    name: ubuntu-24.04 / Python ${{ matrix.python-version }}
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    # IMPORTANT: use login shell so micromamba's activation works
    defaults:
      run:
        shell: bash -l {0}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # Set up micromamba + conda-forge GDAL
      - name: Set up micromamba (conda-forge scientific stack)
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-name: openeo_processes_dask
          create-args: >-
            python=${{ matrix.python-version }}
            gdal
            proj
            geos
            pip
          condarc: |
            channels:
              - conda-forge
              - nodefaults
            channel_priority: strict
          cache-downloads: true
          cache-env: true

      - name: Show GDAL from micromamba env
        run: |
          which python
          python -c "import sys; print('Python:', sys.version)"
          gdalinfo --version || echo "gdalinfo not on PATH?"
          python -c "import subprocess; print('GDAL version (gdalinfo):', subprocess.check_output(['gdalinfo', '--version']).decode().strip())"

      # Install Poetry *inside* the micromamba environment
      - name: Install Poetry in micromamba env
        run: |
          python -m pip install --upgrade pip
          python -m pip install "poetry==$POETRY_VERSION"
          # Make Poetry use the *current* micromamba env, not its own .venv
          poetry config virtualenvs.create false
          poetry config virtualenvs.in-project false

      # (Optional but often handy) cache Poetry's virtualenv-less install
      - name: Cache Poetry dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry
          key: poetry-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            poetry-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Install project dependencies with Poetry
        run: |
          poetry install --with dev --all-extras
          python -c "import os; print('GDAL_LIBRARY_PATH =', os.environ.get('GDAL_LIBRARY_PATH'))"

      - name: Pre-commit hooks
        run: poetry run pre-commit run --all-files

      - name: Run pytest
        run: poetry run pytest --cov=openeo_processes_dask --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml

